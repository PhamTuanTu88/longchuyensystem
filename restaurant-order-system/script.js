// ...existing code...
const MENU = {
  bia: [
    { name: "Bia C·ªëc", price: 10000 },
    { name: "Bia √Çu", price: 40000 },
    { name: "Bia n·ª≠a √Çu", price: 20000 },
    { name: "Bia Th√°p", price: 65000 },
    { name: "R∆∞·ª£u Chai", price: 20000 },
    { name: "R∆∞·ª£u √Çu", price: 80000 },
    { name: "L·∫°c Rang", price: 10000 },
    { name: "Nem Chua", price: 25000 },
    { name: "Nem B√πi", price: 35000 },
    { name: "B√°nh ƒêa", price: 35000 },


{ name: "Th·ªãt chua", price: 60000 },
{ name: "ƒê·∫≠u l∆∞·ªõt", price: 30000 },
{ name: "ƒê·∫≠u chi√™n", price: 30000 },
{ name: "ƒê·∫≠u x·ªët ba ch·ªâ", price: 90000 },
{ name: "ƒê·∫≠u x·ªët t√≥p m·ª°", price: 90000 },
{ name: "Khoai t√¢y chi√™n", price: 30000 },
{ name: "M·ª±c Kh√¥", price: 180000 },
{ name: "M·ª±c X√†o", price: 120000 },
{ name: "M·ª±c h·∫•p", price: 120000 },
{ name: "M·ª±c chi√™n b∆°", price: 120000},
{ name: "D·∫ø m√®n", price: 60000 },
{ name: "Ch·∫•u ch·∫•u", price: 60000 },
{ name: "C√° ch·ªâ v√†ng", price: 40000 },
{ name: "T√≥p m·ª° chi√™n gi√≤n", price: 90000 },
{ name: "Khoai lang chi√™n", price: 30000 },
{ name: "T√¥m H·∫•p", price: 0 },
{ name: "T√≥p m·ª° d∆∞a chua", price: 80000 },
{ name: "T√¥m Chi√™n", price: 0 },
{ name: "Tim x√†o", price: 100000 },
{ name: "Sun x√†o mƒÉng", price: 80000 },
{ name: "M√≥ng gi√≤ lu·ªôc", price: 100000 },
{ name: "M√≥ng gi√≤ quay", price: 100000 },
{ name: "Chim c√¢u quay", price: 120000 },
{ name: "Chim c√¢u x√†o rƒÉm", price: 120000 },
{ name: "Chim c√¢u x√∫c ph·ªìng t√¥m", price: 130000 },
{ name: "C√° ch√©p h·∫•p", price: 0 },
{ name: "c√° ch√©p x√†o", price: 0 },
{ name: "C√° ch√©p r√°n", price: 0 },
{ name: "Tr·∫°ch chi√™n", price: 80000 },
{ name: "ƒêu√¥i heo lu·ªôc", price: 100000 },
{ name: "Ch√¢n gi√≤ quay", price: 100000 },
{ name: "Ch√¢n gi√≤ hun kh√≥i", price: 100000 },
{ name: "Tai cu·ªën h·∫•p", price: 80000 },
{ name: "N·ªôm tai heo", price: 60000 },
{ name: "M√° heo quay", price: 100000 },
{ name: "M√° ƒë√†o ch√°y t·ªèi", price: 100000 },
{ name: "Ngan ch√°y t·ªèi", price: 80000 },
{ name: "V·ªãt ch√°y t·ªèi", price: 80000 },
{ name: "L√≤ng d·ªìi s·ª•n", price: 90000 },
{ name: "Th·ªè n∆∞·ªõng", price: 0 },
{ name: "Th·ªè x√†o lƒÉn", price: 0 },
{ name: "Th·ªè t√°i chanh", price: 0 },
{ name: "Th·ªè h·∫•p", price: 0 },
{ name: "Ti·∫øt canh th·ªè", price: 0 },
{ name: "L√≤ng x√†o d∆∞a", price: 0 },
{ name: "M√®o n∆∞·ªõng", price: 0 },
{ name: "M√®o x√†o lƒÉn", price: 0 },
{ name: "Ch√°o m√®o + canh", price: 0 },
{ name: "M√®o h·∫•p", price: 0 },
{ name: "M√®o t√°i n·ªôm", price: 0 },
{ name: "L√≤ng m√®o x√†o", price: 0 },
{ name: "c√° h·ªìi", price: 0 },
{ name: "D√∫i", price: 0 },
{ name: "Nh√≠m", price: 0 },
{ name: "ba ba", price: 0 },
{ name: "c√° nheo", price: 0 },
{ name: "c√° ch√¨nh", price: 0 },
{ name: "c√° lƒÉng", price: 0 },
{ name: "G√† m·∫πt", price: 0 },
{ name: "G√† su·∫•t", price: 0 },
{ name: "G√† rang mu·ªëi", price: 0 },
{ name: "g√† lu·ªôc", price: 0 },
{ name: "g√† n∆∞·ªõng", price: 0 },
{ name: "g√† chi√™n m·∫Øm", price: 0 },
{ name: "b√≤ chi√™n th√°i lan", price: 120000 },
{ name: "b√≤ t√°i chanh", price: 120000 },
{ name: "b√≤ cu·ªën c·∫£i", price: 120000 },
{ name: "b√≤ x√†o c·∫ßn t·ªèi", price: 120000 },
{ name: "b√≤ x√†o mƒÉng tr√∫c", price: 120000 },
{ name: "b√≤ b√≠t t·∫øt", price: 120000 },
{ name: "b√≤ l√∫c l·∫Øc", price: 120000 },
{ name: "·∫øch rang mu·ªëi", price: 80000 },
{ name: "·∫øch om chu·ªëi ƒë·∫≠u", price: 150000 },
{ name: "·∫øch x√†o x·∫£ ·ªõt", price: 80000 },
{ name: "v·ªãt n∆∞·ªõng", price: 0 },
{ name: "v·ªãt lu·ªôc", price: 0 },
{ name: "v·ªãt rang mu·ªëi", price: 0 },
{ name: "v·ªãt chi√™n gi·ªÅng", price: 0 },
{ name: "v·ªãt x√†o h√†nh rƒÉm", price: 0 },
{ name: "Ch·∫£ n∆∞·ªõng", price: 100000 },
  ],
  lau: [
    { name: "L·∫©u Ri√™u Cua Th·∫≠p C·∫©m", price: 600000 },
    { name: "L·∫©u G√†", price: 600000 },
    { name: "L·∫©u G√† B√≤", price: 600000 },
    { name: "L·∫©u H·∫£i S·∫£n", price: 600000 },
    { name: "L·∫©u C√°", price: 800000 },
    { name: "L·∫©u Ng·ª±a", price: 600000 },
    { name: "L·∫©u ·∫æch", price: 600000 },
    { name: "L·∫©u V·ªãt MƒÉng Cay", price: 600000 },
    { name: "L·∫©u D√™", price: 600000 },
  ],
  co: [
    { name: "C·ªó M√≥n Theo Y√™u C·∫ßu", price: 600000 },
  ]
};

const tableOrders = {};
for (let i = 1; i <= 30; i++) tableOrders[i] = [];

let currentTable = null;
let currentCategory = 'bia';
let pendingCustomItem = null; // hold item when asking for custom price
const ORDERS_KEY = 'tableOrders_v1';

function saveOrders() {
  try {
    localStorage.setItem(ORDERS_KEY, JSON.stringify(tableOrders));
  } catch (e) {
    console.error('Kh√¥ng th·ªÉ l∆∞u order v√†o localStorage', e);
  }
}

function loadOrders() {
  try {
    const raw = localStorage.getItem(ORDERS_KEY);
    if (!raw) return;
    const data = JSON.parse(raw);
    // ensure structure and copy
    for (let i = 1; i <= 30; i++) {
      if (data[i] && Array.isArray(data[i])) {
        tableOrders[i] = data[i];
      } else {
        tableOrders[i] = tableOrders[i] || [];
      }
    }
  } catch (e) {
    console.error('Kh√¥ng th·ªÉ ƒë·ªçc orders t·ª´ localStorage', e);
  }
}

// render b√†n
const grid = document.getElementById('grid');
for (let i = 1; i <= 30; i++) {
  const div = document.createElement('div');
  div.className = 'table-card';
  div.dataset.id = i;
  div.innerHTML = `
    <div class="table-name">B√†n ${i}</div>
    <div class="table-status" id="status-${i}">Tr·ªëng</div>
  `;
  div.onclick = () => selectTable(i);
  grid.appendChild(div);
}

// load persisted orders and update statuses
loadOrders();
for (let i = 1; i <= 30; i++) {
  const st = document.getElementById(`status-${i}`);
  if (tableOrders[i] && tableOrders[i].length > 0) {
    if (st) st.textContent = 'ƒêang order';
  } else {
    if (st) st.textContent = 'Tr·ªëng';
  }
}

function selectTable(id) {
  currentTable = id;
  document.querySelectorAll('.table-card').forEach(el => el.classList.remove('active'));
  document.querySelector(`.table-card[data-id="${id}"]`).classList.add('active');
  document.getElementById('order-title').textContent = `ƒêang order b√†n ${id}`;
  document.getElementById('order-note').textContent = `Ch·ªçn m√≥n ƒë·ªÉ th√™m v√†o b√†n ${id}`;
  renderOrder();
}

function setCategory(cat) {
  currentCategory = cat;
  document.getElementById('tab-bia').classList.remove('active');
  document.getElementById('tab-lau').classList.remove('active');
  document.getElementById('tab-co').classList.remove('active');
  document.getElementById('tab-' + cat).classList.add('active');
  renderMenu();
}

function renderMenu() {
  const wrap = document.getElementById('menu-list');
  wrap.innerHTML = '';
  const query = (document.getElementById('menu-search') && document.getElementById('menu-search').value || '').trim().toLowerCase();
  MENU[currentCategory].filter(it => it.name.toLowerCase().includes(query)).forEach(item => {
    const div = document.createElement('div');
    div.className = 'menu-item';
    // create inner content with a small price/edit button
    const title = document.createElement('h4');
    title.textContent = item.name;
    title.style.cursor = 'pointer';
    title.onclick = () => addToOrder(item);

    const priceWrap = document.createElement('div');
    priceWrap.style.display = 'flex';
    priceWrap.style.justifyContent = 'center';
    priceWrap.style.alignItems = 'center';
    priceWrap.style.gap = '8px';

    const priceText = document.createElement('span');
    priceText.textContent = item.price.toLocaleString() + ' ƒë';
    priceText.style.color = 'var(--primary)';
    priceText.style.fontWeight = '600';

    const priceBtn = document.createElement('button');
    priceBtn.className = 'price-btn';
    priceBtn.title = 'Nh·∫≠p gi√° t√πy ch·ªânh';
    priceBtn.innerHTML = 'üí∞';
    priceBtn.onclick = (e) => { e.stopPropagation(); openPriceModal(item); };

    priceWrap.appendChild(priceText);
    priceWrap.appendChild(priceBtn);

    div.appendChild(title);
    div.appendChild(priceWrap);
    wrap.appendChild(div);
  });
}

function addToOrder(item, customPrice) {
  if (!currentTable) { showNotification('Ch·ªçn b√†n tr∆∞·ªõc', 'error'); return; }
  const list = tableOrders[currentTable];
  const priceToUse = typeof customPrice === 'number' ? customPrice : item.price;
  const idx = list.findIndex(x => x.name === item.name && x.price === priceToUse);
  if (idx >= 0) {
    list[idx].qty += 1;
  } else {
    list.push({ name: item.name, price: priceToUse, qty: 1 });
  }
  document.getElementById(`status-${currentTable}`).textContent = 'ƒêang order';
  renderOrder();
  saveOrders();
  // th√¥ng b√°o cho ng∆∞·ªùi d√πng r·∫±ng ƒë√£ th√™m m√≥n th√†nh c√¥ng
  try { showNotification(`ƒê√£ th√™m "${item.name}" v√†o b√†n ${currentTable}`, 'success'); } catch(e){ console.warn('notify failed', e); }

  try { if (socket && currentTable) socket.emit('order-update', { table: currentTable, order: tableOrders[currentTable] }); } catch(e){}
}

// Open the price modal for custom-price categories
function openPriceModal(item) {
  if (!currentTable) { showNotification('Ch·ªçn b√†n tr∆∞·ªõc', 'error'); return; }
  pendingCustomItem = item;
  const modal = document.getElementById('price-modal');
  const title = document.getElementById('price-modal-title');
  const sub = document.getElementById('price-modal-sub');
  const input = document.getElementById('price-input');
  const qty = document.getElementById('price-qty');
  title.textContent = `Nh·∫≠p gi√° cho: ${item.name}`;
  sub.textContent = `M·∫∑c ƒë·ªãnh: ${item.price.toLocaleString()} ƒë ‚Äî thay ƒë·ªïi n·∫øu kh√°ch y√™u c·∫ßu`;
  input.value = item.price || '';
  qty.value = '1';
  modal.classList.add('show');
}

function closePriceModal() {
  const modal = document.getElementById('price-modal');
  modal.classList.remove('show');
  pendingCustomItem = null;
}

function confirmPrice() {
  const input = document.getElementById('price-input');
  const qty = document.getElementById('price-qty');
  const v = Number(input.value);
  // ensure integer quantity
  let q = Number(qty.value);
  if (!Number.isFinite(q)) q = 1;
  q = Math.floor(Math.max(1, q));
  if (!pendingCustomItem) return closePriceModal();
  if (!v || v <= 0) {
    showNotification('Vui l√≤ng nh·∫≠p gi√° h·ª£p l·ªá (s·ªë l·ªõn h∆°n 0).', 'error');
    return;
  }
  // add item q times with custom price
  const priceRounded = Math.round(v);
  for (let i = 0; i < q; i++) {
    addToOrder(pendingCustomItem, priceRounded);
  }
  closePriceModal();
}

// ƒë·ªïi: m·ªói l·∫ßn b·∫•m s·∫Ω tr·ª´ 1, c√≤n 0 th√¨ x√≥a
function deleteItemFromOrder(index) {
  if (!currentTable) return;
  const list = tableOrders[currentTable];
  if (!list[index]) return;

  list[index].qty -= 1;             // tr·ª´ 1 ƒë∆°n v·ªã
  if (list[index].qty <= 0) {
    list.splice(index, 1);          // h·∫øt th√¨ x√≥a
  }

  if (list.length === 0) {
    document.getElementById(`status-${currentTable}`).textContent = 'Tr·ªëng';
  }

  renderOrder();
  saveOrders();
  try { if (socket && currentTable) socket.emit('order-update', { table: currentTable, order: tableOrders[currentTable] }); } catch(e){}
}

function renderOrder() {
  const tbody = document.getElementById('order-body');
  const totalEl = document.getElementById('order-total');
  tbody.innerHTML = '';
  if (!currentTable) { totalEl.textContent = '0'; return; }

  const list = tableOrders[currentTable];
  let total = 0;
  list.forEach((item, idx) => {
    const line = item.qty * item.price;
    total += line;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${item.name}</td>
      <td>${item.qty}</td>
      <td>${item.price.toLocaleString()}</td>
      <td>${line.toLocaleString()}</td>
      <td><button class="btn-del" onclick="deleteItemFromOrder(${idx})">-1</button></td>
    `;
    tbody.appendChild(tr);
  });
  totalEl.textContent = total.toLocaleString();
}

// DOM modal
const modalEl       = document.getElementById('invoice-modal');
const mTableEl      = document.getElementById('mTable');
const mBodyEl       = document.getElementById('mBody');
const mTotalEl      = document.getElementById('mTotal');
const btnPrint      = document.getElementById('btn-print');
const btnConfirm    = document.getElementById('btn-confirm');
const btnCloseModal = document.getElementById('modal-close');

function openInvoiceModal(bill){
  mTableEl.textContent = bill.table;
  mBodyEl.innerHTML = '';
  bill.items.forEach(item=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td style="padding:6px">${item.name}</td>
      <td style="padding:6px;text-align:right">${item.qty}</td>
      <td style="padding:6px;text-align:right">${currency(item.price)}</td>
      <td style="padding:6px;text-align:right">${currency(item.total)}</td>
    `;
    mBodyEl.appendChild(tr);
  });
  mTotalEl.textContent = currency(bill.totalAmount);
  modalEl.classList.add('show');
}

function closeInvoiceModal(){
  modalEl.classList.remove('show');
}

btnPrint.addEventListener('click', ()=> window.print());
btnCloseModal.addEventListener('click', closeInvoiceModal);
modalEl.addEventListener('click', (e)=>{
  if(e.target === modalEl || e.target.classList.contains('modal__backdrop')){
    closeInvoiceModal();
  }
});

btnConfirm.addEventListener('click', ()=>{
  if (!currentTable) return;
  tableOrders[currentTable] = [];
  const st = document.getElementById(`status-${currentTable}`);
  if (st) st.textContent = 'Tr·ªëng';
  closeInvoiceModal();
  renderOrder();
  saveOrders();
});

let lastBill = null;
const currency = n => Number(n||0).toLocaleString('vi-VN');

// --- Socket.IO real-time sync ---
let socket = null;
try {
  socket = io();
  socket.on('connect', () => console.log('connected to socket', socket.id));

  socket.on('order-update', (payload) => {
    try {
      if (!payload || typeof payload.table === 'undefined') return;
      const t = payload.table;
      tableOrders[t] = payload.order || [];
      const st = document.getElementById(`status-${t}`);
      if (st) st.textContent = (tableOrders[t] && tableOrders[t].length > 0) ? 'ƒêang order' : 'Tr·ªëng';
      if (Number(currentTable) === Number(t)) renderOrder();
      saveOrders();
    } catch (e) { console.error('order-update handling error', e); }
  });

  socket.on('order-cleared', (payload) => {
    try {
      if (!payload || typeof payload.table === 'undefined') return;
      const t = payload.table;
      tableOrders[t] = [];
      const st = document.getElementById(`status-${t}`);
      if (st) st.textContent = 'Tr·ªëng';
      if (Number(currentTable) === Number(t)) renderOrder();
      saveOrders();
    } catch (e) { console.error('order-cleared error', e); }
  });

  socket.on('invoice-saved', (bill) => {
    if (bill && bill.table) {
      showNotification(`H√≥a ƒë∆°n b√†n ${bill.table} ƒë√£ ƒë∆∞·ª£c l∆∞u (thi·∫øt b·ªã kh√°c)`, 'success');
    }
  });

  // remote-print: when a remote device (phone) requests printing, desktop browser can handle it
  const isMobileClient = /Mobi|Android/i.test(navigator.userAgent || '');
  socket.on('remote-print', (data) => {
    try {
      // only attempt to print from non-mobile clients by default
      if (isMobileClient) return;
      // data expected: { table, items: [...], total }
      showNotification(`Nh·∫≠n l·ªánh in t·ª´ thi·∫øt b·ªã kh√°c (b√†n ${data.table})`, 'success');
      // create printable content and open print dialog
      printRemoteInvoice(data);
    } catch (e) { console.error('remote-print handling error', e); }
  });
} catch (e) {
  console.warn('Socket.IO client not available', e);
}

function printRemoteInvoice(data) {
  try {
    const currentDate = new Date();
    const formattedDate = `${currentDate.toLocaleDateString()} ${currentDate.toLocaleTimeString()}`;
    let itemsHtml = '';
    let total = 0;
    (data.items || []).forEach(it => {
      const line = (it.qty || 1) * (Number(it.price) || 0);
      total += line;
      itemsHtml += `<tr><td style="padding:6px">${it.name}</td><td style="padding:6px;text-align:right">${it.qty || 1}</td><td style="padding:6px;text-align:right">${(Number(it.price)||0).toLocaleString()}</td><td style="padding:6px;text-align:right">${line.toLocaleString()}</td></tr>`;
    });

    const html = `
      <html>
        <head>
          <meta charset="utf-8">
          <title>H√≥a ƒë∆°n - B√†n ${data.table}</title>
          <style>
            body{font-family:Arial,Helvetica,sans-serif;padding:12px}
            table{width:100%;border-collapse:collapse}
            th,td{border-bottom:1px solid #ddd}
          </style>
        </head>
        <body>
          <h2>Nh√† H√†ng Long Chuy√™n</h2>
          <h3>H√≥a ƒë∆°n - B√†n ${data.table}</h3>
          <div>Th·ªùi gian: ${formattedDate}</div>
          <table>
            <thead><tr><th>M√≥n</th><th>SL</th><th>Gi√°</th><th>Th√†nh ti·ªÅn</th></tr></thead>
            <tbody>${itemsHtml}</tbody>
          </table>
          <h3 style="text-align:right">T·ªïng: ${total.toLocaleString()} ƒë</h3>
        </body>
      </html>
    `;

    const printWindow = window.open('', '_blank', 'width=600,height=600');
    if (!printWindow) {
      showNotification('Kh√¥ng th·ªÉ m·ªü c·ª≠a s·ªï in. Vui l√≤ng cho ph√©p popup.', 'error');
      return;
    }
    printWindow.document.open();
    printWindow.document.write(html);
    printWindow.document.close();
    // give browser a moment to render then trigger print
    setTimeout(() => {
      try { printWindow.focus(); printWindow.print(); } catch (e) { console.error('print failed', e); }
    }, 500);
  } catch (e) {
    console.error('printRemoteInvoice error', e);
    showNotification('L·ªói khi th·ª±c hi·ªán in t·ª´ thi·∫øt b·ªã kh√°c', 'error');
  }
}

// Printer registration UI + handlers
let printerRegistered = false;
function updatePrinterButton() {
  let btn = document.getElementById('printer-toggle');
  if (!btn) return;
  btn.textContent = printerRegistered ? 'H·ªßy ƒëƒÉng k√Ω m√°y in' : 'ƒêƒÉng k√Ω l√†m m√°y in';
  btn.style.background = printerRegistered ? '#c0392b' : '#2ecc71';
}

function togglePrinterRegistration() {
  if (!socket) { showNotification('Kh√¥ng k·∫øt n·ªëi socket', 'error'); return; }
  if (printerRegistered) {
    socket.emit('unregister-printer');
  } else {
    // optional meta: hostname or user info
    const meta = { name: navigator.userAgent, when: new Date().toISOString() };
    socket.emit('register-printer', meta);
  }
}

// socket responses
try {
  if (socket) {
    socket.on('printer-registered', (info) => {
      printerRegistered = true; updatePrinterButton();
      showNotification('Thi·∫øt b·ªã ƒë√£ ƒëƒÉng k√Ω l√†m m√°y in', 'success');
      console.log('printer-registered', info);
    });
    socket.on('printer-unregistered', () => {
      printerRegistered = false; updatePrinterButton();
      showNotification('ƒê√£ h·ªßy ƒëƒÉng k√Ω m√°y in', 'success');
    });
  }
} catch (e) { console.warn('printer socket handlers not attached', e); }

// inject a small floating button on desktop to register as printer
document.addEventListener('DOMContentLoaded', () => {
  const isMobileClient = /Mobi|Android/i.test(navigator.userAgent || '');
  if (isMobileClient) return; // only show on non-mobile
  const btn = document.createElement('button');
  btn.id = 'printer-toggle';
  btn.style.position = 'fixed';
  btn.style.right = '12px';
  btn.style.bottom = '12px';
  btn.style.zIndex = 9999;
  btn.style.padding = '10px 12px';
  btn.style.borderRadius = '6px';
  btn.style.border = 'none';
  btn.style.color = '#fff';
  btn.style.cursor = 'pointer';
  btn.onclick = togglePrinterRegistration;
  document.body.appendChild(btn);
  updatePrinterButton();
});

// H√†m hi·ªÉn th·ªã th√¥ng b√°o
function showNotification(message, type = 'success') {
  const modal = document.getElementById('notification-modal');
  const messageEl = document.getElementById('notification-message');
  const iconEl = document.getElementById('notification-icon');
  const contentEl = modal.querySelector('.notification-content');
  
  messageEl.textContent = message;
  
  // X√≥a c√°c class c≈©
  contentEl.classList.remove('success', 'error');
  contentEl.classList.add(type);
  
  // ƒê·∫∑t icon
  if (type === 'success') {
    iconEl.textContent = '‚úì';
  } else if (type === 'error') {
    iconEl.textContent = '‚úï';
  }
  
  modal.classList.add('show');
}

function closeNotification() {
  const modal = document.getElementById('notification-modal');
  modal.classList.remove('show');
}

function saveBill(bill) {
  const rec = {
    id: 'HD' + Date.now(),
    time: new Date().toLocaleString('vi-VN'),
    table: bill.table,
    total: bill.totalAmount
  };
  const key = 'bills';
  const arr = JSON.parse(localStorage.getItem(key) || '[]');
  arr.push(rec);
  localStorage.setItem(key, JSON.stringify(arr));
}

function loadBills() {
  return JSON.parse(localStorage.getItem('bills') || '[]');
}

function payment() {
  if (!currentTable) {
    showNotification('Ch·ªçn b√†n tr∆∞·ªõc', 'error');
    return;
  }

  const orderList = tableOrders[currentTable];
  if (orderList.length === 0) {
    showNotification('Kh√¥ng c√≥ m√≥n n√†o trong ƒë∆°n h√†ng.', 'error');
    return;
  }

  let total = 0;
  orderList.forEach(item => {
    total += item.qty * item.price;
  });

  let billContent = `
    <h2>H√≥a ƒë∆°n - B√†n ${currentTable}</h2>
    <table style="width:100%;border-collapse:collapse">
      <thead>
        <tr>
          <th style="text-align:left;padding:6px">M√≥n</th>
          <th style="text-align:right;padding:6px">SL</th>
          <th style="text-align:right;padding:6px">Gi√°</th>
          <th style="text-align:right;padding:6px">Th√†nh ti·ªÅn</th>
        </tr>
      </thead>
      <tbody>
  `;

  orderList.forEach(item => {
    const line = item.qty * item.price;
    billContent += `
      <tr>
        <td style="padding:6px">${item.name}</td>
        <td style="padding:6px;text-align:right">${item.qty}</td>
        <td style="padding:6px;text-align:right">${item.price.toLocaleString()}</td>
        <td style="padding:6px;text-align:right">${line.toLocaleString()}</td>
      </tr>
    `;
  });

  billContent += `
    </tbody>
    </table>
    <h3 style="text-align:right;margin-top:12px">T·ªïng c·ªông: ${total.toLocaleString()} ƒë</h3>
  `;

  // Build modal using existing modal styles so body can scroll and footer stays visible
  const wrapper = document.createElement('div');
  wrapper.id = 'payment-modal';
  wrapper.className = 'modal show';
  wrapper.innerHTML = `
    <div class="modal__backdrop"></div>
    <div class="modal__dialog">
      <div class="modal__header">
        <div>
          <div style="font-weight:700">Nh√† H√†ng Long Chuy√™n</div>
          <div class="subtitle">H√≥a ƒë∆°n b√†n ${currentTable}</div>
        </div>
        <button class="modal__close" aria-label="ƒê√≥ng">√ó</button>
      </div>

      <div class="modal__body">
        ${billContent}
      </div>

      <div class="modal__footer">
        <button id="payment-print" class="btn-primary" onclick="printBill()">In h√≥a ƒë∆°n</button>
        <button id="payment-paid" class="btn-primary outline" onclick="markAsPaid()">ƒê√£ thanh to√°n</button>
      </div>
    </div>
  `;

  document.body.appendChild(wrapper);

  // close handlers
  const backdrop = wrapper.querySelector('.modal__backdrop');
  const closeBtn = wrapper.querySelector('.modal__close');
  backdrop.addEventListener('click', () => wrapper.remove());
  closeBtn.addEventListener('click', () => wrapper.remove());
}

function printBill() {
  const modalBody = document.querySelector('#payment-modal .modal__body') || document.querySelector('.modal__body');
  const billContent = modalBody ? modalBody.innerHTML : '';
  const isMobileClient = /Mobi|Android/i.test(navigator.userAgent || '');
  // If mobile, send a remote-print request to the server so a connected PC browser can print
  if (isMobileClient) {
    const orderList = tableOrders[currentTable] || [];
    const total = orderList.reduce((t, it) => t + (it.qty * it.price), 0);
    const paymentData = { table: currentTable, items: orderList, total };
    fetch('/remote-print', {
      method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(paymentData)
    })
    .then(r => r.json())
    .then(resp => {
      if (resp && resp.ok) showNotification('ƒê√£ g·ª≠i l·ªánh in t·ªõi m√°y in (qua tr√¨nh duy·ªát m√°y t√≠nh).', 'success');
      else showNotification(resp.message || 'Kh√¥ng g·ª≠i ƒë∆∞·ª£c l·ªánh in.', 'error');
    })
    .catch(err => { console.error('remote-print error', err); showNotification('L·ªói khi g·ª≠i l·ªánh in', 'error'); });
    return;
  }
  const currentDate = new Date();
  const formattedDate = `${currentDate.toLocaleDateString()} ${currentDate.toLocaleTimeString()}`;
  const billWithDate = `
    <div style="text-align: 0;">
      <h1>Nh√† H√†ng Long Chuy√™n</h1>
      <h2>H√≥a ƒë∆°n - B√†n ${currentTable}</h2>
      <p><i>Ng√†y: ${formattedDate}</i></p>
      ${billContent}
    </div>
  `;
  const printWindow = window.open('', '', 'width=600,height=400');
  printWindow.document.write(billWithDate);
  printWindow.document.close();
  printWindow.print();
}

function markAsPaid() {
  const orderList = tableOrders[currentTable];
  const total = orderList.reduce((total, item) => total + item.qty * item.price, 0);

  const paymentData = {
    table: currentTable,
    items: orderList,
    total: total,
  };

  fetch('/save-invoice', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(paymentData),
  })
  .then(response => response.json())
  .then(data => {
    showNotification(data.message || 'L∆∞u h√≥a ƒë∆°n th√†nh c√¥ng!', 'success');

    // X√≥a order c·ªßa b√†n (ghi l·∫°i id tr∆∞·ªõc khi reset currentTable)
    const clearedTable = currentTable;
    tableOrders[clearedTable] = [];
    const stEl = document.getElementById(`status-${clearedTable}`);
    if (stEl) stEl.textContent = 'Tr·ªëng';

    // Reset l·∫°i currentTable v√† UI
    currentTable = null;
    document.querySelectorAll('.table-card').forEach(el => el.classList.remove('active'));
    document.getElementById('order-title').textContent = 'Ch∆∞a ch·ªçn b√†n';
    document.getElementById('order-note').textContent = 'B·∫•m b√†n b√™n tr√°i ƒë·ªÉ b·∫Øt ƒë·∫ßu order';

    renderOrder();

    // ƒê√≥ng modal thanh to√°n
    const modal = document.getElementById('payment-modal');
    if (modal) {
      modal.remove();
    }

    saveOrders();
    // notify other clients that this table was cleared
    try { if (socket) socket.emit('order-cleared', { table: clearedTable }); } catch(e){}
  })
  .catch(error => {
    console.error('Error:', error);
    showNotification('C√≥ l·ªói x·∫£y ra khi l∆∞u h√≥a ƒë∆°n.', 'error');
  });
}
// ...existing code...
// Reports: client helpers
let _lastReport = null;

function formatNumber(n){ return Number(n||0).toLocaleString(); }

function getReport() {
  const type = document.getElementById('report-type').value;
  const date = document.getElementById('report-date').value;
  const q = `type=${encodeURIComponent(type)}&date=${encodeURIComponent(date)}`;
  fetch(`/reports?${q}`)
    .then(r => r.json())
    .then(data => {
      document.getElementById('report-total').textContent = formatNumber(data.total);
      document.getElementById('report-count').textContent = data.count || 0;
      _lastReport = data;
      showNotification('B√°o c√°o ƒë√£ t·∫£i', 'success');
    })
    .catch(err => {
      console.error(err);
      showNotification('Kh√¥ng l·∫•y ƒë∆∞·ª£c b√°o c√°o', 'error');
    });
}

function downloadCSV(filename, rows) {
  const csv = rows.map(r => r.map(v => '"' + String(v).replace(/"/g, '""') + '"').join(',')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename; a.style.display = 'none';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

function exportReportCSV() {
  if (!_lastReport) {
    showNotification('Ch∆∞a c√≥ b√°o c√°o ƒë·ªÉ xu·∫•t', 'error');
    return;
  }
  const from = _lastReport.from || '';
  const to = _lastReport.to || '';
  const rows = [ ['from','to','total','count'], [from, to, _lastReport.total, _lastReport.count] ];
  const when = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
  downloadCSV(`report-${when}.csv`, rows);
}

// wire up report controls
// Summary storage (collected by pressing 'T·ªïng k·∫øt')
const SUMMARIES_KEY = 'collectedSummaries_v1';

function loadSummaries(){
  try { return JSON.parse(localStorage.getItem(SUMMARIES_KEY) || '[]'); } catch(e){ return []; }
}
function saveSummaries(arr){
  try { localStorage.setItem(SUMMARIES_KEY, JSON.stringify(arr)); } catch(e){ console.error('Cannot save summaries', e); }
}

function addToSummary(){
  if (!currentTable) { showNotification('Ch·ªçn b√†n tr∆∞·ªõc ƒë·ªÉ t·ªïng k·∫øt', 'error'); return; }
  const orderList = tableOrders[currentTable] || [];
  if (orderList.length === 0) { showNotification('Kh√¥ng c√≥ m√≥n ƒë·ªÉ t·ªïng k·∫øt', 'error'); return; }

  const total = orderList.reduce((s, it) => s + it.qty * it.price, 0);
  const rec = { id: 'S' + Date.now(), table: currentTable, total, time: new Date().toISOString() };
  const arr = loadSummaries();
  arr.push(rec);
  saveSummaries(arr);
  renderCollectedSummaries();
  showNotification('ƒê√£ th√™m v√†o kho t·ªïng k·∫øt', 'success');
}

function renderCollectedSummaries(){
  const wrap = document.getElementById('collected-summaries');
  if (!wrap) return;
  const arr = loadSummaries();
  if (arr.length === 0) { wrap.innerHTML = '<div style="color:var(--text-secondary)">Ch∆∞a c√≥ m·ª•c t·ªïng k·∫øt n√†o</div>'; return; }
  wrap.innerHTML = '';
  arr.slice().reverse().forEach(item => {
    const el = document.createElement('div');
    el.style = 'padding:6px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center';
    el.innerHTML = `<div><strong>B√†n ${item.table}</strong><div style="font-size:12px;color:var(--text-secondary)">${new Date(item.time).toLocaleString()}</div></div><div style="text-align:right"><div>${Number(item.total).toLocaleString()} ƒë</div></div>`;
    wrap.appendChild(el);
  });
}

function clearSummaries(){
  if (!confirm('X√≥a t·∫•t c·∫£ m·ª•c t·ªïng k·∫øt?')) return;
  saveSummaries([]);
  renderCollectedSummaries();
}

function exportSummariesCSV(){
  const arr = loadSummaries();
  if (!arr || arr.length === 0) { showNotification('Kh√¥ng c√≥ m·ª•c n√†o ƒë·ªÉ xu·∫•t', 'error'); return; }
  const rows = [['id','table','time','total']].concat(arr.map(a=>[a.id,a.table,a.time,a.total]));
  const when = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
  downloadCSV(`summaries-${when}.csv`, rows);
}

function toggleReports(){
  const c = document.getElementById('reports-container');
  if (!c) return;
  const shown = c.style.display !== 'none';
  c.style.display = shown ? 'none' : 'block';
  if (!shown) renderCollectedSummaries();
}

// wire up report controls and summary buttons on DOM ready
document.addEventListener('DOMContentLoaded', () => {
  const dateEl = document.getElementById('report-date');
  if (dateEl) {
    const today = new Date();
    dateEl.value = today.toISOString().slice(0,10);
  }
  const btn = document.getElementById('btn-get-report');
  if (btn) btn.addEventListener('click', getReport);
  const bex = document.getElementById('btn-export-report');
  if (bex) bex.addEventListener('click', exportReportCSV);

  const toggleBtn = document.getElementById('btn-toggle-reports');
  if (toggleBtn) toggleBtn.addEventListener('click', toggleReports);

  const addSummaryBtn = document.getElementById('btn-add-summary');
  if (addSummaryBtn) addSummaryBtn.addEventListener('click', addToSummary);

  const clearBtn = document.getElementById('btn-clear-summaries');
  if (clearBtn) clearBtn.addEventListener('click', clearSummaries);

  const exportSummBtn = document.getElementById('btn-export-summaries');
  if (exportSummBtn) exportSummBtn.addEventListener('click', exportSummariesCSV);

  // initial render if reports visible
  const reportsContainer = document.getElementById('reports-container');
  if (reportsContainer && reportsContainer.style.display !== 'none') renderCollectedSummaries();
});